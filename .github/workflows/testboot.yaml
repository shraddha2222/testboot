name: Deploy Spring Boot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Cleanup workspace
        run: rm -rf app target *.jar || true

      - name: Ensure build tools exist
        run: |
          java -version
          mvn -version
          rsync --version

      - name: Create minimal Spring Boot app
        run: |
          mkdir -p app/src/main/java/com/example
          mkdir -p app/src/main/resources

          cat > app/src/main/java/com/example/DemoApplication.java << 'EOF'
          package com.example;

          import org.springframework.boot.SpringApplication;
          import org.springframework.boot.autoconfigure.SpringBootApplication;
          import org.springframework.web.bind.annotation.GetMapping;
          import org.springframework.web.bind.annotation.RestController;

          @SpringBootApplication
          public class DemoApplication {
              public static void main(String[] args) {
                  SpringApplication.run(DemoApplication.class, args);
              }
          }

          @RestController
          class HelloController {
              @GetMapping("/")
              public String hello() {
                  return "Hello World from Spring Boot!";
              }
          }
          EOF

          cat > app/pom.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.example</groupId>
              <artifactId>demo</artifactId>
              <version>0.0.1</version>

              <parent>
                  <groupId>org.springframework.boot</groupId>
                  <artifactId>spring-boot-starter-parent</artifactId>
                  <version>2.7.18</version>
              </parent>

              <properties>
                  <java.version>17</java.version>
              </properties>

              <dependencies>
                  <dependency>
                      <groupId>org.springframework.boot</groupId>
                      <artifactId>spring-boot-starter-web</artifactId>
                  </dependency>
              </dependencies>
          </project>
          EOF

      - name: Build JAR
        run: |
          cd app
          mvn clean package -DskipTests
          ls -lh target/*.jar
          
      - name: Trust target host
        run: |
          ssh-keyscan -H 192.168.35.9 >> ~/.ssh/known_hosts
  

      - name: Deploy JAR to target VM
        run: |
          rsync -avz app/target/demo-0.0.1.jar \
            deploy@192.168.35.9:/opt/springboot-app/app.jar

      - name: Restart service
        run: |
          ssh deploy@192.168.35.9 \
            "sudo systemctl daemon-reload && sudo systemctl restart springboot-app"
