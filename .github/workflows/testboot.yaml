name: Deploy Spring Boot

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger button

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Cleanup
        run: rm -rf app target *.jar || true

      - name: Install dependencies
        run: |
          sudo dnf check-update
          sudo dnf install -y maven java-17-openjdk-devel git openssh-clients rsync

      - name: Fetch public Spring Boot repo
        run: |
          git clone https://github.com/bratzelk/spring-boot-hello-world.git ./app
          cd app && ls -la

      - name: Build Spring Boot JAR
        run: |
          cd app
          mvn clean package -DskipTests
          ls -la target/

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{secrets.VM_B_SSH_KEY}}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 192.168.35.9 >> ~/.ssh/known_hosts

      - name: Copy JAR to target VM
        run: |
          rsync -avz app/target/*.jar \
            deploy@192.168.35.9:/opt/springboot-app/app.jar

      - name: Restart service on target VM
        run: |
          ssh deploy@192.168.35.9 \
            'sudo systemctl daemon-reload || true; sudo systemctl restart springboot-app && sudo systemctl status springboot-app --no-pager'
